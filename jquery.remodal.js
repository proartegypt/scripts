(function(e){"use strict";var t={overlayDelay:300,hideDelay:300,cookieExpires:365,debug:false,clickClose:true,animationDuration:800,animationEasing:"linear",gaTracking:false},n=false,r=false,i=false,s=0,o=[],u=[],a=[],f=e("<div />").addClass("_utmodal-overlay").attr("id","_utmodal-overlay").css("display","none"),l={init:function(){if(t.gaTracking){if(_gaq!=="undefined"){i=true}else{if(t.debug){console.log("GA not loaded. Tracking disabled.")}}}if(window.localStorage){n=true}else{if(t.debug){console.log("Web storage not supported. Using jQuery.cookie plugin.")}}if($j.cookie){r=true}else{if(t.debug){console.log("jQuery.cookie plugin not loaded. Cookies have been disabled.")}}l.countModals();l.setupModals();l.eventHandler()},showModal:function(s){var a=e("#"+s),c=false,h=t.animationEasing,p=t.animationDuration,d,v,m=true,g=t.cookieExpires;if(!a.length){if(t.debug){console.log("#"+s+" not found.")}return false}a.addClass("_utmodal-modal");l.positionModal(s,"center");if(!e("#_utmodal-overlay").length){e("body").append(f)}if(a.data("animation")){if(a.data("animation").indexOf("|")>=0){v=a.data("animation").split("|");if(v[0]){d=v[0]}if(v[1]){h=v[1]}if(v[2]){p=parseInt(v[2],10)}}else{d=a.data("animation")}c=true;l.positionModal(s,d)}f.fadeIn(t.overlayDelay);if(c){a.show().animate({left:l.calculatePos(a,"left"),top:l.calculatePos(a,"top")},{duration:p,specialEasing:{top:h}})}else{a.fadeIn(t.overlayDelay)}if(i&&a.data("name")){l.gaTrackEvent("Modal: "+a.data("name"),"Opened")}if(a.data("time")){if(a.data("close")&&a.data("close")==="manual"){m=false;e(".close",a).hide()}if(m){o[s]=window.setTimeout(function(){var e=false;if(a.hasClass("sticky")){a.removeClass("sticky");e=true}l.closeModal(s);if(e){a.addClass("sticky")}},a.data("time")*1e3)}if(e(".sec",a).length){e(".sec",a).text(a.data("time"));u[s]=window.setInterval(function(){var t=parseInt(e(".sec",a).text(),10)-1;if(t>=0){e(".sec",a).text(t)}else{if(!m&&e(".close",a).is(":hidden")){if(a.hasClass("sticky")&&a.data("time")){a.removeClass("sticky").addClass("wasSticky")}e(".close",a).show()}window.clearInterval(u[s])}},1e3)}}if(a.hasClass("once")){if(n){localStorage["utModal-"+s]="shown"}else if(r){if(a.data("expires")){g=a.data("expires")}$j.cookie("utModal-"+s,"shown",{path:"/",expires:g})}if(e("."+s).length){e("."+s).unbind("click")}}},closeModal:function(n){if(e("#"+n).length){var r=e("#"+n);if(!r.hasClass("sticky")){if(r.hasClass("wasSticky")){r.removeClass("wasSticky").addClass("sticky")}if(u[n]){window.clearInterval(u[n])}if(o[n]){window.clearTimeout(o[n])}r.fadeOut(t.hideDelay,function(){if(!e("._utmodal-modal:visible").length){l.removeOverlay()}});if(i&&r.data("name")){l.gaTrackEvent("Modal: "+r.data("name"),"Closed")}}}},removeOverlay:function(){if(e("#_utmodal-overlay").length){e("#_utmodal-overlay").fadeOut(t.hideDelay,function(){e(this).remove()})}},positionModal:function(t,n){if(t){if(e("#"+t).length){var r=e("#"+t);if(n){switch(n){case"top":r.css({top:-r.height(),left:l.calculatePos(r,"left")});break;case"bottom":r.css({top:e(window).height()+r.height(),left:l.calculatePos(r,"left")});break;case"left":r.css({top:l.calculatePos(r,"top"),left:-r.width()});break;case"right":r.css({top:l.calculatePos(r,"top"),left:e(window).width()+r.width()});break;case"center":r.css({top:(e(window).height()-r.height())/2,left:(e(window).width()-r.width())/2});break}}else{r.css({top:l.calculatePos(r,"top"),left:l.calculatePos(r,"left")})}}}},calculatePos:function(t,n){var r=e(window).width(),i=e(window).height(),s=t.width(),o=t.height();switch(n){case"left":return(r-s)/2;case"top":return(i-o)/2}},countModals:function(){s=e("._utmodal").length;if(t.debug){console.log(s+" modals found.")}},eventHandler:function(){if(t.shortkeys){e(document).keyup(function(t){if(t.keyCode===27){$j.each(e("._utmodal-modal"),function(){if(!e(this).hasClass("sticky")){var t=e(this).attr("id");l.closeModal(t)}})}})}e("._utmodal .close").bind("click",function(){var t=e(this).closest("._utmodal").attr("id");l.closeModal(t)});e(window).resize(function(){$j.each(e("._utmodal"),function(){var t=e(this).attr("id");l.positionModal(t)})});if(t.clickClose){e("body").delegate("#_utmodal-overlay","click",function(t){t.preventDefault();$j.each(e("._utmodal-modal"),function(){l.closeModal(e(this).attr("id"))})})}},setupModals:function(){e("._utmodal").each(function(){var i=e(this),o=true,u,f;if(!i.attr("id")){while(o){f="SM-"+Math.floor(Math.random()*s+1);if(!e("#"+f).length){i.attr("id",f);o=false}}}u=i.attr("id");if($j.inArray(u,a)>-1){if(t.debug){console.log(" Multiple #"+u)}}a.push(u);if(i.hasClass("once")){if(n){if(localStorage["utModal-"+u]==="shown"){i.remove();i=false;l.countModals()}}else if(r){if($j.cookie("utModal-"+u)==="shown"){i.remove();i=false;l.countModals()}}}if(i){i.hide();if(i.hasClass("auto")){if(i.data("wait")){setTimeout(function(){l.showModal(u)},i.data("wait")*1e3)}else{l.showModal(u)}}if(e("."+u).length){e("."+u).bind("click",function(e){e.preventDefault();l.showModal(u)})}}})},gaTrackEvent:function(e,t,n,r){if(i){_gaq.push(["_trackEvent",e,t,n,r])}}};$j.utModal=function(e,n){if(typeof e==="object"){t=$j.extend(t,e)}else if(typeof e==="string"&&typeof n==="string"){switch(e){case"show":l.showModal(n);break;case"hide":l.closeModal(n);break;default:if(t.debug){console.log(e+"not valid.")}break}}else if(typeof e==="string"&&typeof n==="object"){switch(e){case"init":if(n){t=$j.extend(t,n)}l.init();break;case"settings":t=$j.extend(t,n);break;default:if(t.debug){console.log(e+" not valid.")}break}}else{l.init()}}})(jQuery)
